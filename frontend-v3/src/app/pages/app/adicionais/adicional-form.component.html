<div class="adicional-form-page">
  <div class="page-header">
    <div>
      <h1 class="text-up-04 text-weight-bold mb-1">
        {{ isEditMode() ? 'Editar adicional' : 'Novo adicional' }}
      </h1>
      <p class="text-base text-muted">Defina grupo, regras e preços dos adicionais.</p>
    </div>
    <div class="header-actions">
      <br-button type="button" emphasis="secondary" density="small" (click)="goBack()">
        <i class="fas fa-arrow-left mr-2"></i>Voltar
      </br-button>
      <br-button type="button" emphasis="primary" density="small" [disabled]="saving()" (click)="submit()">
        {{ saving() ? 'Salvando...' : 'Salvar' }}
      </br-button>
    </div>
  </div>

  <div class="messages" *ngIf="feedback()">
    <br-message
      [state]="feedback()?.type"
      [message]="feedback()?.text"
      [isClosable]="true"
      [showIcon]="true"
      (brDidClose)="clearFeedback()">
    </br-message>
  </div>

  <br-card>
    <div slot="header" class="card-header-content">
      <span>Dados do adicional</span>
    </div>

    <div class="card-body" slot="content">
      <div class="loading-container" *ngIf="loading()">
        <br-loading label="Carregando..."></br-loading>
      </div>

      <div *ngIf="!loading()">
      <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
        <div class="form-grid">
          <div class="form-group">
            <br-select
              label="Categoria *"
              placeholder="Selecione"
              [options]="categoriaOptions()"
              [value]="selectedCategoriaValue()"
              [state]="invalid('id_categoria') ? 'danger' : undefined"
              (valueChange)="onCategoriaChange($event)">
            </br-select>
            <br-message
              *ngIf="invalid('id_categoria')"
              state="danger"
              is-feedback
              message="Selecione uma categoria">
            </br-message>
          </div>

          <div class="form-group">
            <br-input
              formControlName="nome"
              ngDefaultControl
              label="Nome *"
              placeholder="Ex: Molhos adicionais"
              [state]="invalid('nome') ? 'danger' : undefined">
            </br-input>
            <br-message
              *ngIf="invalid('nome')"
              state="danger"
              is-feedback
              message="Informe um nome (até 150 caracteres)">
            </br-message>
          </div>

          <div class="form-group">
            <br-select
              label="Tipo de seleção *"
              placeholder="Selecione"
              [options]="selecaoOptions"
              [value]="selectedSelecaoValue()"
              [state]="invalid('selecao') ? 'danger' : undefined"
              (valueChange)="onSelecaoChange($event)">
            </br-select>
            <div class="helper-text">
              <span>U = único obrigatório • M = múltiplo • Q = quantidade com mínimo/máximo</span>
            </div>
            <br-message
              *ngIf="invalid('selecao')"
              state="danger"
              is-feedback
              message="Selecione o tipo de seleção">
            </br-message>
          </div>
        </div>

        <!-- Regras de seleção - só exibe para M (Múltiplo) ou Q (Quantidade) -->
        <ng-container *ngIf="form.get('selecao')?.value === 'Q' || form.get('selecao')?.value === 'M'">
          <div class="divider"></div>

          <div class="section">
            <div class="section-title">
              <i class="fas fa-sliders-h"></i>
              Regras de seleção
            </div>

            <div class="form-grid">
              <div class="form-group" *ngIf="form.get('selecao')?.value === 'Q'">
                <br-input
                  formControlName="minimo"
                  ngDefaultControl
                  type="number"
                  min="0"
                  label="Mínimo *"
                  placeholder="0"
                  [state]="invalid('minimo') ? 'danger' : undefined">
                </br-input>
                <br-message
                  *ngIf="invalid('minimo')"
                  state="danger"
                  is-feedback
                  message="Informe mínimo >= 0">
                </br-message>
              </div>

              <div class="form-group">
                <br-input
                  formControlName="limite"
                  ngDefaultControl
                  type="number"
                  min="1"
                  label="{{ form.get('selecao')?.value === 'Q' ? 'Limite *' : 'Limite (opcional)' }}"
                  placeholder="1"
                  [state]="(invalid('limite') || form.hasError('limiteInvalido')) ? 'danger' : undefined">
                </br-input>
                <br-message
                  *ngIf="invalid('limite') && form.get('selecao')?.value === 'Q'"
                  state="danger"
                  is-feedback
                  message="Limite obrigatório (>=1) para seleção Q">
                </br-message>
                <br-message
                  *ngIf="form.hasError('limiteInvalido')"
                  state="danger"
                  is-feedback
                  message="Limite deve ser maior ou igual ao mínimo">
                </br-message>
                <div class="helper-text" *ngIf="form.get('selecao')?.value === 'M'">
                  Deixe vazio para ilimitado.
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <div class="divider"></div>

        <div class="section">
          <div class="section-title">
            <i class="fas fa-plus-circle"></i>
            Opções e preços *
          </div>

          <div class="opcoes-container" [class.error]="opcoesArray.length === 0">
            <div class="opcoes-header">
              <span>#</span>
              <span>Opção</span>
              <span>Valor (R$)</span>
            </div>

          <div class="opcao-row" *ngFor="let opGroup of opcoesArray.controls; let i = index" [formGroup]="opGroup">
            <div class="col-index">{{ i + 1 }}</div>
            <div class="col-nome">
              <br-input
                  formControlName="nome"
                  ngDefaultControl
                  placeholder="Ex: Cheddar"
                  [state]="invalidOpcao(opGroup,'nome') ? 'danger' : undefined">
              </br-input>
              <br-message *ngIf="invalidOpcao(opGroup,'nome')" is-feedback state="danger" message="Nome obrigatório"></br-message>
            </div>
            <div class="col-valor">
              <br-input
                  formControlName="valor"
                  ngDefaultControl
                  type="number"
                  step="0.01"
                  min="0"
                  placeholder="0,00"
                  [state]="invalidOpcao(opGroup,'valor') ? 'danger' : undefined">
              </br-input>
              <br-message *ngIf="invalidOpcao(opGroup,'valor')" is-feedback state="danger" message="Valor obrigatório"></br-message>
            </div>
              <div class="col-actions">
                <br-button type="button" emphasis="tertiary" density="small" (click)="removeOpcao(i)">
                  <i class="fas fa-trash"></i>
                </br-button>
              </div>
            </div>

            <div class="empty-opcoes" *ngIf="opcoesArray.length === 0">
              <i class="fas fa-inbox"></i>
              <span>Nenhuma opção adicionada</span>
            </div>
          </div>

          <div class="opcoes-actions">
            <br-button type="button" emphasis="secondary" density="small" (click)="addOpcao()">
              <i class="fas fa-plus mr-2"></i>Adicionar opção
            </br-button>
          </div>

          <br-message
            *ngIf="opcoesArray.length === 0"
            state="danger"
            is-feedback
            message="Cadastre ao menos uma opção com valor.">
          </br-message>
        </div>

        <div class="form-actions">
          <br-button type="button" emphasis="secondary" (click)="goBack()">Cancelar</br-button>
          <br-button type="submit" emphasis="primary" [disabled]="saving()">
            {{ saving() ? 'Salvando...' : 'Salvar adicional' }}
          </br-button>
        </div>
      </form>
      </div>
    </div>
  </br-card>
</div>
