<div class="produto-list-page">
  <div class="page-header">
    <div>
      <h1 class="text-up-04 text-weight-bold mb-1">Produtos</h1>
      <p class="text-base text-muted">Cadastre produtos e preços por opção.</p>
    </div>
    <div class="header-actions">
      <br-button type="button" emphasis="secondary" density="small" (click)="loadProdutos()">
        <i class="fas fa-sync mr-2"></i>Recarregar
      </br-button>
      <br-button type="button" emphasis="primary" density="small" (click)="goToNew()">
        <i class="fas fa-plus mr-2"></i>Novo produto
      </br-button>
    </div>
  </div>

  <div class="messages" *ngIf="error() || feedback()">
    <br-message
      *ngIf="error()"
      state="danger"
      [message]="error()"
      [isClosable]="true"
      [showIcon]="true"
      (brDidClose)="dismissError()">
    </br-message>
    <br-message
      *ngIf="feedback()"
      state="success"
      [message]="feedback()"
      [isClosable]="true"
      [showIcon]="true"
      (brDidClose)="dismissFeedback()">
    </br-message>
  </div>

  <br-card>
    <div slot="header" class="card-header-content">
      <span>Lista de produtos</span>
    </div>

    <div class="card-body" slot="content">
      <div class="filters">
        <div class="filter-item">
          <br-select
            label="Categoria"
            placeholder="Todas"
            [options]="filterOptions()"
            [value]="selectedCategoria()"
            (valueChange)="onFilterChange($event)">
          </br-select>
        </div>
        <div class="filter-item search">
          <br-input
            label="Buscar"
            placeholder="Nome, descrição ou categoria"
            type="search"
            (valueChange)="onSearchChange($event)">
          </br-input>
        </div>
      </div>

      <div class="loading-container" *ngIf="loading()">
        <br-loading label="Carregando produtos..."></br-loading>
      </div>

      <div class="table-container" *ngIf="!loading()">
        <br-table *ngIf="paginatedProdutos().length > 0">
          <br-table-header-row [attr.slot]="'header'">
            <br-table-header-cell>Produto</br-table-header-cell>
            <br-table-header-cell>Categoria</br-table-header-cell>
            <br-table-header-cell>Opções / Preços</br-table-header-cell>
            <br-table-header-cell>Status</br-table-header-cell>
            <br-table-header-cell horizontalAlign="center">Ações</br-table-header-cell>
          </br-table-header-row>

          <br-table-row
            [attr.slot]="'row'"
            *ngFor="let prod of paginatedProdutos(); trackBy: trackByProd">
            <br-table-cell>
              <div class="nome">
                <div class="title">{{ prod.nome }}</div>
                <div class="subtitle" *ngIf="prod.descricao">{{ prod.descricao }}</div>
              </div>
            </br-table-cell>

            <br-table-cell>
              <br-tag
                shape="rounded"
                density="small"
                [label]="categoriaNome(prod.id_categoria)"
                bgColor="blue-warm-vivid-60">
              </br-tag>
            </br-table-cell>

            <br-table-cell>
              <div class="precos">
                <ng-container *ngIf="(prod.opcoes?.length || 0) === 0; else precosTpl">
                  <span class="text-muted">Sem preços</span>
                </ng-container>
                <ng-template #precosTpl>
                  <br-tag
                    *ngFor="let p of prod.opcoes"
                    shape="rounded"
                    density="small"
                    [label]="precoLabel(p)"
                    [bgColor]="p.status ? 'green-vivid-20' : 'gray-20'">
                  </br-tag>
                </ng-template>
              </div>
            </br-table-cell>

            <br-table-cell>
              <br-tag
                shape="rounded"
                density="small"
                [label]="prod.status ? 'Ativo' : 'Inativo'"
                [bgColor]="statusColor(prod)">
              </br-tag>
            </br-table-cell>

            <br-table-cell horizontalAlign="center">
              <div class="actions">
                <br-button type="button" emphasis="tertiary" density="small" (click)="goToEdit(prod.id_produto)">
                  <i class="fas fa-pen"></i>
                </br-button>
                <br-button type="button" emphasis="tertiary" density="small" (click)="confirmarExcluir(prod)">
                  <i class="fas fa-trash"></i>
                </br-button>
              </div>
            </br-table-cell>
          </br-table-row>
        </br-table>

        <div class="empty-state" *ngIf="paginatedProdutos().length === 0">
          <i class="fas fa-box-open"></i>
          <p>Nenhum produto encontrado</p>
        </div>
      </div>

      <div class="pagination-container" *ngIf="!loading() && totalItems() > 0">
        <br-pagination
          [total]="totalPages()"
          [current]="currentPage()"
          [totalItems]="totalItems()"
          [perPage]="perPage()"
          [perPageOptions]="[5, 10, 25, 50]"
          variant="contextual"
          itemsText="produtos"
          perPageLabel="Itens por página"
          goToPageLabel="Ir para página"
          (pageChange)="onPageChange($event)"
          (perPageChange)="onPerPageChange($event)">
        </br-pagination>
      </div>
    </div>
  </br-card>
</div>
