<div class="produto-form-page">
  <div class="page-header">
    <div>
      <h1 class="text-up-04 text-weight-bold mb-1">
        {{ isEditMode() ? 'Editar Produto' : 'Novo Produto' }}
      </h1>
      <p class="text-base text-muted">Gestão de cardápio</p>
    </div>
    <div class="header-actions">
      <br-button type="button" emphasis="secondary" (click)="goBack()">
        <i class="fas fa-arrow-left mr-1"></i> Voltar
      </br-button>
    </div>
  </div>

  <!-- Mensagem de Feedback -->
  <div class="messages" *ngIf="feedback()">
    <br-message
      [state]="feedback()?.type"
      [message]="feedback()?.text"
      [isClosable]="true"
      [showIcon]="true"
      (brDidClose)="clearFeedback()">
    </br-message>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading()">
    <br-loading label="Carregando produto..."></br-loading>
  </div>

  <br-card *ngIf="!loading()">
    <div slot="header" class="card-header-content">
      <span>Dados do Produto</span>
    </div>

    <div class="card-body" slot="content">
      <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
        <!-- Dados Básicos -->
        <div class="form-grid">
          <div class="form-group">
            <br-select
              label="Categoria *"
              placeholder="Selecione a categoria"
              [options]="categoriaOptions()"
              [value]="selectedCategoriaValue()"
              [state]="invalid('id_categoria') ? 'danger' : undefined"
              (valueChange)="onCategoriaChange($event)">
            </br-select>
            <br-message *ngIf="invalid('id_categoria')" is-feedback state="danger" message="Selecione uma categoria"></br-message>
          </div>

          <div class="form-group">
            <br-input
              formControlName="nome"
              ngDefaultControl
              label="Nome do Produto *"
              placeholder="Ex: Pizza Calabresa, Açaí 500ml..."
              [state]="invalid('nome') ? 'danger' : undefined">
            </br-input>
            <br-message *ngIf="invalid('nome')" is-feedback state="danger" message="Informe um nome (máx. 150 caracteres)"></br-message>
          </div>

          <div class="form-group full-width">
            <br-input
              formControlName="descricao"
              ngDefaultControl
              label="Descrição"
              placeholder="Ingredientes ou observações (opcional)">
            </br-input>
          </div>
        </div>

        <!-- Separador -->
        <hr class="divider">

        <!-- Opções e Preços -->
        <div class="section-title">
          <i class="fas fa-tags"></i>
          <span>Opções e Preços *</span>
        </div>

        <div class="opcoes-container" [class.error]="opcoesInvalidas()">
          <ng-container *ngIf="opcoesFormArray.length; else noOpcoes">
            <!-- Header da tabela -->
            <div class="opcoes-header">
              <div class="col-check"></div>
              <div class="col-nome">Opção</div>
              <div class="col-valor">Valor (R$)</div>
            </div>

            <!-- Linhas de opções -->
            <div class="opcao-row" *ngFor="let opcao of opcoesFormArray.controls; let i = index" [formGroup]="$any(opcao)">
              <div class="col-check">
                <br-checkbox
                  [checked]="opcao.get('habilitado')?.value"
                  (checkedChange)="onHabilitadoChange(i, $event)">
                </br-checkbox>
              </div>
              <div class="col-nome">
                <span class="opcao-nome">{{ opcao.get('nome')?.value }}</span>
              </div>
              <div class="col-valor">
                <br-input
                  type="number"
                  step="0.01"
                  min="0"
                  placeholder="0,00"
                  [value]="opcao.get('valor')?.value"
                  (valueChange)="onValorChange(i, $event)"
                  [disabled]="!opcao.get('habilitado')?.value">
                </br-input>
              </div>
            </div>
          </ng-container>

          <ng-template #noOpcoes>
            <div class="empty-opcoes">
              <i class="fas fa-info-circle"></i>
              <span>Selecione uma categoria para ver as opções disponíveis</span>
            </div>
          </ng-template>
        </div>

        <br-message *ngIf="opcoesInvalidas()" is-feedback state="danger" message="Habilite e preencha o valor de pelo menos uma opção"></br-message>

        <span class="helper-text" *ngIf="opcoesFormArray.length">
          <i class="fas fa-info-circle mr-1"></i>
          Marque as opções disponíveis para este produto e informe os valores
        </span>

        <!-- Footer -->
        <div class="form-actions">
          <br-button type="button" emphasis="secondary" (click)="goBack()">
            Cancelar
          </br-button>
          <br-button type="submit" emphasis="primary" [disabled]="saving()">
            <i class="fas fa-check mr-1"></i>
            {{ saving() ? 'Salvando...' : 'Salvar' }}
          </br-button>
        </div>
      </form>
    </div>
  </br-card>
</div>
