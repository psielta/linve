<div class="categoria-form-page">
  <div class="page-header">
    <div>
      <h1 class="text-up-04 text-weight-bold mb-1">
        {{ isEditMode() ? 'Editar Categoria' : 'Nova Categoria' }}
      </h1>
      <p class="text-base text-muted">Gestão de cardápio</p>
    </div>
    <div class="header-actions">
      <br-button type="button" emphasis="secondary" (click)="goBack()">
        <i class="fas fa-arrow-left mr-1"></i> Voltar
      </br-button>
    </div>
  </div>

  <!-- Mensagem de Feedback -->
  <div class="messages" *ngIf="feedback()">
    <br-message
      [state]="feedback()?.type"
      [message]="feedback()?.text"
      [isClosable]="true"
      [showIcon]="true"
      (brDidClose)="clearFeedback()">
    </br-message>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading()">
    <br-loading label="Carregando categoria..."></br-loading>
  </div>

  <br-card *ngIf="!loading()">
    <div slot="header" class="card-header-content">
      <span>Dados da Categoria</span>
    </div>

    <div class="card-body" slot="content">
      <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
        <!-- Dados Basicos -->
        <div class="form-grid">
          <div class="form-group">
            <br-select
              label="Culinária *"
              placeholder="Selecione a culinária"
              [options]="culinariaOptions()"
              [value]="selectedCulinariaValue()"
              [state]="invalid('id_culinaria') ? 'danger' : undefined"
              (valueChange)="onCulinariaChange($event)">
            </br-select>
            <br-message *ngIf="invalid('id_culinaria')" is-feedback state="danger" message="Selecione uma culinária"></br-message>
          </div>

          <div class="form-group">
            <br-input
              formControlName="nome"
              ngDefaultControl
              label="Nome da Categoria *"
              placeholder="Ex: Açaís, Pizzas, Bebidas..."
              [state]="invalid('nome') ? 'danger' : undefined">
            </br-input>
            <br-message *ngIf="invalid('nome')" is-feedback state="danger" message="Informe um nome (máx. 150 caracteres)"></br-message>
          </div>

          <div class="form-group full-width">
            <br-input
              formControlName="descricao"
              ngDefaultControl
              label="Descrição"
              placeholder="Breve descrição para o cliente (opcional)">
            </br-input>
          </div>

          <div class="form-group">
            <br-input
              formControlName="ordem"
              ngDefaultControl
              type="number"
              label="Ordem no cardápio"
              placeholder="Ex: 1, 2, 3...">
            </br-input>
            <span class="helper-text">Define a posição desta categoria no cardápio</span>
          </div>

          <div class="form-group">
            <br-select
              label="Opção meia (pizzas)"
              placeholder="Sem meia"
              [options]="opcaoMeiaOptions"
              [disabled]="!culinariaSupportsMeioMeio()"
              [value]="selectedOpcaoMeiaValue()"
              (valueChange)="onOpcaoMeiaChange($event)">
            </br-select>
            <span class="helper-text" *ngIf="!culinariaSupportsMeioMeio()">
              Selecione uma culinária que suporte meio a meio
            </span>
          </div>
        </div>

        <!-- Separador -->
        <hr class="divider">

        <!-- Opcoes/Tamanhos -->
        <div class="section-title">
          <i class="fas fa-list"></i>
          <span>Opções (Tamanhos/Variações) *</span>
        </div>

        <div class="options-row">
          <div class="options-input">
            <br-input
              label="Adicionar opção"
              placeholder="Digite e pressione Enter (ex: Pequeno, Médio, Grande)"
              type="text"
              [value]="novaOpcao"
              (valueChange)="novaOpcao = ($event.detail || '')"
              (keydown.enter)="addOpcao(); $event.preventDefault()">
            </br-input>
          </div>
          <br-button type="button" emphasis="secondary" (click)="addOpcao()">
            <i class="fas fa-plus mr-1"></i> Adicionar
          </br-button>
        </div>

        <div class="chips-area" *ngIf="opcoesValue().length > 0">
          <div class="chip" *ngFor="let op of opcoesValue()">
            <span>{{ op }}</span>
            <button type="button" class="chip-remove" (click)="removeOpcao(op)" title="Remover">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <br-message *ngIf="invalid('opcoes')" is-feedback state="danger" message="Cadastre ao menos uma opção para esta categoria"></br-message>

        <!-- Separador -->
        <hr class="divider">

        <!-- Horario e Dias -->
        <div class="form-grid-2">
          <div class="form-block">
            <div class="section-title">
              <i class="fas fa-clock"></i>
              <span>Horário de Funcionamento</span>
            </div>

            <div class="time-grid">
              <div class="form-group">
                <br-input
                  formControlName="inicio"
                  ngDefaultControl
                  type="time"
                  label="Início"
                  placeholder="00:00">
                </br-input>
              </div>
              <div class="form-group">
                <br-input
                  formControlName="fim"
                  ngDefaultControl
                  type="time"
                  label="Fim"
                  placeholder="23:59">
                </br-input>
              </div>
            </div>

            <span class="helper-text">
              <i class="fas fa-info-circle mr-1"></i>
              Deixe vazio para disponível o dia todo
            </span>

            <br-message *ngIf="hasHorarioError()" is-feedback state="danger" message="Horário inválido. Preencha ambos (HH:MM) com início menor que fim."></br-message>
          </div>

          <div class="form-block">
            <div class="section-title">
              <i class="fas fa-calendar-alt"></i>
              <span>Dias Disponíveis</span>
            </div>

            <div class="dias-grid">
              <div *ngFor="let dia of diasSemana" class="dia-item">
                <br-checkbox
                  [label]="dia.label"
                  [checked]="form.get(dia.control)?.value"
                  (checkedChange)="onDiaChange(dia.control, $event)">
                </br-checkbox>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="form-actions">
          <br-button type="button" emphasis="secondary" (click)="goBack()">
            Cancelar
          </br-button>
          <br-button type="submit" emphasis="primary" [disabled]="saving()">
            <i class="fas fa-check mr-1"></i>
            {{ saving() ? 'Salvando...' : 'Salvar' }}
          </br-button>
        </div>
      </form>
    </div>
  </br-card>
</div>
